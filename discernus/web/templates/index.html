{% extends "base.html" %}

{% block title %}Research Dashboard - Discernus{% endblock %}

{% block extra_head %}
<style>
    .dashboard-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 30px;
        margin-top: 20px;
    }
    
    .dashboard-section {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 20px;
    }
    
    .dashboard-section h2 {
        color: #2c3e50;
        font-size: 1.3rem;
        margin-bottom: 15px;
        border-left: 4px solid #3498db;
        padding-left: 15px;
    }
    
    .view-all-link {
        text-align: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
    }
    
    .view-all-link a {
        color: #3498db;
        text-decoration: none;
        font-weight: bold;
    }
    
    .view-all-link a:hover {
        text-decoration: underline;
    }
    
    /* Responsive: Stack on mobile */
    @media (max-width: 768px) {
        .dashboard-grid {
            grid-template-columns: 1fr;
            gap: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="section">
    <h1 style="text-align: center; margin-bottom: 10px;">🏠 Research Dashboard</h1>
    <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">
        Recent sessions and available corpora for conversation-native academic research
    </p>
    
    <div class="dashboard-grid">
        <div class="dashboard-section">
            <h2>🔬 Recent Research Sessions</h2>
            <div id="sessions-container">
                <div class="loading">
                    <div>🔬 Loading recent sessions...</div>
                    <div style="font-size: 0.9rem; color: #7f8c8d; margin-top: 10px;">
                        💡 First load may take 20-30 seconds while generating intelligent summaries.<br>
                        Subsequent loads will be instant thanks to THIN caching.
                    </div>
                </div>
            </div>
            <div class="view-all-link">
                <a href="/sessions">📋 View All Sessions →</a>
            </div>
        </div>
        
        <div class="dashboard-section">
            <h2>📂 Available Research Corpora</h2>
            <div id="corpora-container">
                <div class="loading">
                    <div>📚 Discovering available corpora...</div>
                    <div style="font-size: 0.9rem; color: #7f8c8d; margin-top: 10px;">
                        💡 First load may take 15-20 seconds while LLM analyzes corpus contents.<br>
                        Subsequent loads will be instant thanks to THIN caching.
                    </div>
                </div>
            </div>
            <div class="view-all-link">
                <a href="/corpora">📚 View All Corpora →</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Load and display research sessions
async function loadSessions() {
    const startTime = Date.now();
    const container = document.getElementById('sessions-container');
    
    // Add loading timer
    const timer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const timerElement = container.querySelector('.loading-timer');
        if (timerElement) {
            timerElement.textContent = `⏱️ ${elapsed}s elapsed...`;
        }
    }, 1000);
    
    // Add timer element
    container.innerHTML = `
        <div class="loading">
            <div>🔬 Loading research sessions...</div>
            <div class="loading-timer" style="font-weight: bold; color: #3498db; margin: 5px 0;">⏱️ 0s elapsed...</div>
            <div style="font-size: 0.9rem; color: #7f8c8d; margin-top: 10px;">
                💡 First load may take 20-30 seconds while generating intelligent summaries.<br>
                Subsequent loads will be instant thanks to THIN caching.
            </div>
        </div>
    `;
    
    try {
        const response = await fetch('/api/sessions?limit=5');
        const data = await response.json();
        
        clearInterval(timer);
        const loadTime = ((Date.now() - startTime) / 1000).toFixed(1);
        
        if (data.status === 'success' && data.sessions.length > 0) {
            const cacheMessage = loadTime > 5 ? 
                `<div style="background: #e8f4fd; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 0.9rem;">
                    ⚡ <strong>Loaded in ${loadTime}s</strong> - First-time LLM analysis complete! 
                    Next reload will be instant thanks to THIN caching.
                </div>` : 
                `<div style="background: #d4edda; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 0.9rem;">
                    🚀 <strong>Loaded in ${loadTime}s</strong> - Blazing fast thanks to THIN caching!
                </div>`;
            
            container.innerHTML = cacheMessage + data.sessions.map(session => `
                <div class="card">
                    <h3>📋 ${session.friendly_name}</h3>
                    <div class="meta">
                        📅 ${formatDate(session.timestamp)} • 
                        📊 ${session.corpus_description}
                    </div>
                    <div class="description">
                        <strong>Research Question:</strong> ${session.research_question}<br>
                        <strong>Summary:</strong> ${session.summary}
                    </div>
                    ${session.key_findings && session.key_findings.length > 0 ? `
                        <div style="margin: 10px 0;">
                            <strong>Key Findings:</strong>
                            <ul style="margin: 5px 0 0 20px;">
                                ${session.key_findings.map(finding => `<li>${finding}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    <div style="margin-top: 15px;">
                        <a href="/session/${session.id}" class="btn" style="font-size: 0.9rem; padding: 8px 12px;">📖 View Conversation</a>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #7f8c8d;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">🚀</div>
                    <div><strong>No completed sessions yet</strong></div>
                    <div style="font-size: 0.9rem; margin: 10px 0;">Start your first research session</div>
                    <a href="/new-session" class="btn" style="font-size: 0.9rem;">✨ Start Research</a>
                </div>
            `;
        }
    } catch (error) {
        clearInterval(timer);
        document.getElementById('sessions-container').innerHTML = `
            <div class="error">
                ❌ Error loading sessions: ${error.message}
            </div>
        `;
    }
}

// Load and display available corpora
async function loadCorpora() {
    const startTime = Date.now();
    const container = document.getElementById('corpora-container');
    
    // Add loading timer
    const timer = setInterval(() => {
        const elapsed = Math.floor((Date.now() - startTime) / 1000);
        const timerElement = container.querySelector('.loading-timer');
        if (timerElement) {
            timerElement.textContent = `⏱️ ${elapsed}s elapsed...`;
        }
    }, 1000);
    
    // Add timer element
    container.innerHTML = `
        <div class="loading">
            <div>📚 Discovering available corpora...</div>
            <div class="loading-timer" style="font-weight: bold; color: #3498db; margin: 5px 0;">⏱️ 0s elapsed...</div>
            <div style="font-size: 0.9rem; color: #7f8c8d; margin-top: 10px;">
                💡 First load may take 15-20 seconds while LLM analyzes corpus contents.<br>
                Subsequent loads will be instant thanks to THIN caching.
            </div>
        </div>
    `;
    
    try {
        const response = await fetch('/api/corpora?limit=5');
        const data = await response.json();
        
        clearInterval(timer);
        const loadTime = ((Date.now() - startTime) / 1000).toFixed(1);
        
        if (data.status === 'success' && data.corpora.length > 0) {
            const cacheMessage = loadTime > 5 ? 
                `<div style="background: #e8f4fd; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 0.9rem;">
                    ⚡ <strong>Loaded in ${loadTime}s</strong> - First-time LLM analysis complete! 
                    Next reload will be instant thanks to THIN caching.
                </div>` : 
                `<div style="background: #d4edda; padding: 10px; border-radius: 4px; margin-bottom: 15px; font-size: 0.9rem;">
                    🚀 <strong>Loaded in ${loadTime}s</strong> - Blazing fast thanks to THIN caching!
                </div>`;
            
            container.innerHTML = cacheMessage + data.corpora.map(corpus => `
                <div class="card">
                    <h3>📚 ${corpus.friendly_name}</h3>
                    <div class="meta">
                        🌐 ${corpus.language} • 
                        📅 ${corpus.time_period} • 
                        📊 ${corpus.file_count} files (${formatFileSize(corpus.total_size)})
                    </div>
                    <div class="description">
                        ${corpus.description}
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>Research Themes:</strong><br>
                        ${corpus.research_themes.map(theme => `<span class="badge">${theme}</span>`).join('')}
                    </div>
                    <div style="margin: 10px 0; font-family: monospace; background: #f8f9fa; padding: 8px; border-radius: 4px; font-size: 0.9rem;">
                        <strong>📍 Path:</strong> 
                        <span style="user-select: all;">${corpus.path}</span>
                        <button onclick="copyToClipboard('${corpus.path}')" style="margin-left: 10px; padding: 2px 6px; font-size: 0.8rem;" class="btn">📋 Copy</button>
                    </div>
                    ${corpus.sample_files && corpus.sample_files.length > 0 ? `
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; font-weight: bold;">📋 Sample Files</summary>
                            <div style="margin-top: 8px; font-family: monospace; font-size: 0.9rem;">
                                ${corpus.sample_files.map(file => `<div>• ${file}</div>`).join('')}
                            </div>
                        </details>
                    ` : ''}
                    <div style="margin-top: 15px;">
                        <a href="/new-session?corpus=${encodeURIComponent(corpus.path)}" class="btn" style="font-size: 0.9rem; padding: 8px 12px;">🚀 Start Research</a>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div style="text-align: center; padding: 40px 20px; color: #7f8c8d;">
                    <div style="font-size: 2rem; margin-bottom: 10px;">📂</div>
                    <div><strong>No corpora discovered</strong></div>
                    <div style="font-size: 0.9rem; margin: 10px 0;">Add text collections to data/ or projects/</div>
                </div>
            `;
        }
    } catch (error) {
        clearInterval(timer);
        document.getElementById('corpora-container').innerHTML = `
            <div class="error">
                ❌ Error loading corpora: ${error.message}
            </div>
        `;
    }
}

// Load everything when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadSessions();
    loadCorpora();
});
</script>
{% endblock %} 