{% extends "base.html" %}

{% block title %}{{ session_id }} - Research Session{% endblock %}

{% block extra_head %}
<style>
    /* Enhanced styles for conversation display */
    .session-header {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 20px;
        margin-bottom: 30px;
    }
    
    .session-header h1 {
        color: #2c3e50;
        margin-bottom: 10px;
    }
    
    .session-meta {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin-bottom: 15px;
    }
    
    .research-question {
        background: white;
        border-left: 4px solid #3498db;
        padding: 15px;
        margin: 15px 0;
        border-radius: 0 4px 4px 0;
    }
    
    .conversation-content {
        background: white;
        border: 1px solid #e9ecef;
        border-radius: 6px;
        padding: 25px;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Georgia', serif;
        line-height: 1.7;
        max-width: none;
    }
    
    /* Markdown-style formatting for conversation */
    .conversation-content h1 {
        color: #2c3e50;
        border-bottom: 2px solid #3498db;
        padding-bottom: 10px;
        margin: 30px 0 20px 0;
        font-size: 1.8rem;
    }
    
    .conversation-content h2 {
        color: #2c3e50;
        border-left: 4px solid #3498db;
        padding-left: 15px;
        margin: 25px 0 15px 0;
        font-size: 1.4rem;
    }
    
    .conversation-content h3 {
        color: #2c3e50;
        margin: 20px 0 10px 0;
        font-size: 1.2rem;
    }
    
    .conversation-content pre {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        overflow-x: auto;
        font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        font-size: 0.9rem;
        margin: 15px 0;
    }
    
    .conversation-content code {
        background: #f1f3f4;
        padding: 2px 4px;
        border-radius: 3px;
        font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
        font-size: 0.9rem;
    }
    
    .conversation-content ul, .conversation-content ol {
        margin: 10px 0 10px 30px;
    }
    
    .conversation-content li {
        margin: 5px 0;
    }
    
    .conversation-content blockquote {
        border-left: 4px solid #95a5a6;
        margin: 15px 0;
        padding: 10px 15px;
        background: #f8f9fa;
        font-style: italic;
    }
    
    .conversation-content table {
        border-collapse: collapse;
        width: 100%;
        margin: 15px 0;
    }
    
    .conversation-content th, .conversation-content td {
        border: 1px solid #e9ecef;
        padding: 8px 12px;
        text-align: left;
    }
    
    .conversation-content th {
        background: #f8f9fa;
        font-weight: bold;
    }
    
    /* Special highlighting for system prompts and LLM responses */
    .conversation-content h3:contains("System Prompt"),
    .conversation-content h2:contains("SYSTEM PROMPTS") {
        color: #8e44ad;
        border-left-color: #8e44ad;
    }
    
    .conversation-content h3:contains("LLM"),
    .conversation-content h3:contains("Detective"),
    .conversation-content h3:contains("Design"),
    .conversation-content h3:contains("Moderator") {
        color: #27ae60;
        border-left: 4px solid #27ae60;
        padding-left: 15px;
    }
    
    .back-nav {
        margin-bottom: 20px;
    }
    
    .back-nav a {
        color: #3498db;
        text-decoration: none;
        font-size: 0.9rem;
    }
    
    .back-nav a:hover {
        text-decoration: underline;
    }
    
    .toc {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        padding: 15px;
        margin: 20px 0;
    }
    
    .toc h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
    }
    
    .toc ul {
        margin: 0;
        padding-left: 20px;
    }
    
    .toc a {
        color: #3498db;
        text-decoration: none;
    }
    
    .toc a:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block content %}
<div class="back-nav">
    <a href="/">‚Üê Back to Research Dashboard</a>
</div>

<div class="session-header">
    <h1>üìã Research Session</h1>
    <div class="session-meta">
        üìÅ Session ID: <strong>{{ session_id }}</strong><br>
        {% if metadata.started_at %}
        üìÖ Started: <strong>{{ metadata.started_at }}</strong><br>
        {% endif %}
        {% if metadata.status %}
        üîÑ Status: <strong>{{ metadata.status }}</strong>
        {% endif %}
    </div>
    
    {% if metadata.research_question %}
    <div class="research-question">
        <strong>üéØ Research Question:</strong><br>
        {{ metadata.research_question }}
    </div>
    {% endif %}
</div>

<div class="section">
    <h2>üí¨ Complete Research Conversation</h2>
    <div class="conversation-content" id="conversation-content">
        <div class="loading">Loading conversation...</div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Convert markdown-style content to HTML with academic formatting
function formatConversationContent(content) {
    // Simple markdown-to-HTML conversion for academic display
    let html = content
        // Headers
        .replace(/^# (.*$)/gm, '<h1>$1</h1>')
        .replace(/^## (.*$)/gm, '<h2>$1</h2>')
        .replace(/^### (.*$)/gm, '<h3>$1</h3>')
        
        // Code blocks
        .replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>')
        .replace(/`([^`]+)`/g, '<code>$1</code>')
        
        // Bold and italic
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/\*([^*]+)\*/g, '<em>$1</em>')
        
        // Line breaks
        .replace(/\n\n/g, '</p><p>')
        .replace(/\n/g, '<br>')
        
        // Wrap in paragraphs
        .replace(/^(.+)$/gm, '<p>$1</p>')
        
        // Clean up empty paragraphs
        .replace(/<p><\/p>/g, '')
        .replace(/<p><br><\/p>/g, '')
        
        // Special academic formatting
        .replace(/\*\*(Model Information:|Research Question:|Summary:)/g, '<strong style="color: #2c3e50;">$1</strong>')
        .replace(/üìã|üîç|üé®|üîÑ|üí¨/g, '<span style="font-size: 1.2rem;">$&</span>');
    
    return html;
}

// Load conversation content
async function loadConversation() {
    try {
        const response = await fetch(`/api/session/{{ session_id }}/conversation`);
        const data = await response.json();
        
        const container = document.getElementById('conversation-content');
        
        if (data.status === 'success') {
            // Display the conversation content with academic formatting
            container.innerHTML = formatConversationContent(data.content);
            
            // Add table of contents if the conversation is long
            generateTableOfContents();
            
        } else {
            container.innerHTML = `
                <div class="error">
                    ‚ùå Error loading conversation: ${data.message}
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('conversation-content').innerHTML = `
            <div class="error">
                ‚ùå Error loading conversation: ${error.message}
            </div>
        `;
    }
}

// Generate table of contents for long conversations
function generateTableOfContents() {
    const headers = document.querySelectorAll('#conversation-content h1, #conversation-content h2, #conversation-content h3');
    
    if (headers.length > 3) {
        const toc = document.createElement('div');
        toc.className = 'toc';
        toc.innerHTML = '<h4>üìã Conversation Contents</h4><ul>' + 
            Array.from(headers).map((header, index) => {
                const id = `section-${index}`;
                header.id = id;
                const level = parseInt(header.tagName.substring(1));
                const indent = level > 1 ? 'style="margin-left: ' + ((level - 1) * 15) + 'px;"' : '';
                return `<li ${indent}><a href="#${id}">${header.textContent}</a></li>`;
            }).join('') + 
            '</ul>';
        
        const conversationContainer = document.getElementById('conversation-content');
        conversationContainer.insertBefore(toc, conversationContainer.firstChild);
    }
}

// Load conversation when page loads
document.addEventListener('DOMContentLoaded', loadConversation);
</script>
{% endblock %} 