name: CI - Development Velocity

# Trigger on pushes and pull requests to maintain development velocity
on:
  push:
    branches: [ main, develop, 'feature/*', 'fix/*', 'codex/*' ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
    
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r tests/test_requirements.txt
    
    - name: Run unit tests
      run: |
        echo "üß™ Running unit tests (Phase 1 CI)..."
        python3 -m pytest tests/unit/ -v --tb=short --maxfail=5
    
    - name: Basic import validation
      run: |
        echo "üîç Validating core imports..."
        python3 -c "
        try:
            import src.utils.cost_manager
            import src.models.base
            import src.coordinate_engine
            print('‚úÖ Core imports successful')
        except ImportError as e:
            print(f'‚ùå Import error: {e}')
            exit(1)
        "
    
    - name: License compliance check
      run: |
        echo "üìã Checking license compliance..."
        cd product_management/license_audit
        if python3 compliance_checker.py; then
          echo "‚úÖ License compliance validated"
        else
          echo "‚ö†Ô∏è License compliance check failed (non-blocking for development velocity)"
          echo "   This is often due to environment-specific package issues"
          echo "   Manual license review recommended before production"
        fi
    
    - name: Test configuration validation
      run: |
        echo "‚öôÔ∏è Validating test configuration..."
        python3 -c "
        import os
        import sys
        
        # Check test structure
        test_dirs = ['tests/unit', 'tests/integration', 'tests/utilities']
        for test_dir in test_dirs:
            if not os.path.exists(test_dir):
                print(f'‚ùå Missing test directory: {test_dir}')
                sys.exit(1)
        
        # Check requirements files
        req_files = ['requirements.txt', 'tests/test_requirements.txt']
        for req_file in req_files:
            if not os.path.exists(req_file):
                print(f'‚ùå Missing requirements file: {req_file}')
                sys.exit(1)
        
        print('‚úÖ Test configuration validated')
        "

  # Quick integration smoke test (optional, can fail without blocking)
  integration-smoke-test:
    runs-on: ubuntu-latest
    needs: test
    continue-on-error: true  # Don't block development on framework issues
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install -r tests/test_requirements.txt
    
    - name: Quick integration test
      run: |
        echo "üî¨ Running integration smoke test..."
        echo "‚ö†Ô∏è This test may fail due to framework documentation issues"
        echo "üéØ Goal: Catch obvious integration problems without blocking development"
        
        # Run a subset of integration tests that don't require full system health
        if python3 -m pytest tests/integration/test_api_schemas.py -v --tb=short; then
          echo "‚úÖ Integration smoke test passed"
        else
          echo "‚ö†Ô∏è Integration smoke test failed (not blocking)"
        fi

  # Summary job
  ci-summary:
    runs-on: ubuntu-latest
    needs: [test, integration-smoke-test]
    if: always()
    
    steps:
    - name: CI Summary
      run: |
        echo "üèÅ CI Summary for Development Velocity"
        echo "=================================="
        
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "‚úÖ Core Tests: PASSED"
        else
          echo "‚ùå Core Tests: FAILED"
        fi
        
        if [ "${{ needs.integration-smoke-test.result }}" == "success" ]; then
          echo "‚úÖ Integration Smoke Test: PASSED"
        else
          echo "‚ö†Ô∏è Integration Smoke Test: FAILED (non-blocking)"
        fi
        
        echo ""
        echo "üìä Phase 1 CI Goals:"
        echo "‚Ä¢ Fast feedback (< 5 minutes)"
        echo "‚Ä¢ Catch import/syntax errors"
        echo "‚Ä¢ Validate license compliance"
        echo "‚Ä¢ Maintain development velocity"
        echo ""
        
        if [ "${{ needs.test.result }}" == "success" ]; then
          echo "üéâ Development can continue - core functionality validated!"
        else
          echo "üö® Core tests failed - please fix before merging"
          exit 1
        fi 